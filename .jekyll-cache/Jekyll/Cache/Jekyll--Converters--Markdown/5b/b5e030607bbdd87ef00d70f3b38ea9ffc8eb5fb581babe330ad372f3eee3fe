I"◊7<p>Hoy vamos a estar resolviendo la m√°quina <em>Kenobi</em> de <em>TryHackMe</em>. Esta es una m√°quina f√°cil tanto en la intrusi√≥n como en la escalada de privilegios, por lo que no supondr√° ninguna complicaci√≥n a la hora de realizarla.</p>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/1.png" alt="" /></p>

<h3 id="fase-de-reconocimiento"><a href="#header-3"></a>Fase De Reconocimiento</h3>

<p>Primeramente, vamos a utilizar la herramienta <em>Nmap</em> para determinar que puertos est√°n abiertos as√≠ como identificar la versi√≥n y servicios que corren en el activo.</p>

<p>Para determinar que puertos est√°n abiertos podemos realizar lo siguiente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-T5</span> <span class="nt">-v</span> <span class="nt">-n</span> &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p>Y en caso de que el escaneo tarde demasiado en completar, tenemos esta otra alternativa:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p>A continuaci√≥n se explican los par√°metros utilizados en el escaneo de puertos con <em>Nmap</em>:</p>

<ul>
  <li>p - Escanea todo el rango de puertos (65535 en total)</li>
  <li>open - Nos indica todos aquellos puertos que est√°n abiertos (o posiblemente abiertos)</li>
  <li>T5 - La plantilla de temporizado nos permite agilizar nuestro escaneo, este valor puede ir desde 0 hasta 5, cabe aclarar que a mayor sea el valor de la plantilla, ‚Äúgeneraremos m√°s ruido‚Äù, pero no pasa nada ¬øno? Al fin y al cabo estamos practicando en un entorno controlado y aqu√≠ somos todos <code class="language-plaintext highlighter-rouge">White Hat</code></li>
  <li>v - <em>Verbose</em>, reporta lo encontrado por consola</li>
  <li>n - No aplicar <em>resoluci√≥n DNS</em></li>
  <li>sS - Escaneo <em>TCP SYN</em></li>
  <li>min-rate - Emitir paquetes no m√°s lentos que &lt;valor&gt; por segundo</li>
  <li>vvv - Triple <em>verbose</em>, para obtener mayor informaci√≥n por consola</li>
  <li>Pn - No aplicar <em>host discovery</em></li>
</ul>

<p>Para determinar la versi√≥n y servicios que corren bajo estos puertos podemos realizar lo siguiente:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap <span class="nt">-sC</span> <span class="nt">-sV</span> <span class="nt">-p</span> 21,22,80,111,139,445,2049,35049,41843,47869,50933 &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p>A continuaci√≥n se explican los par√°metros utilizados en el escaneo de versiones y servicios con <em>Nmap</em>:</p>

<ul>
  <li>sC - Scripts b√°sicos de enumeraci√≥n</li>
  <li>sV - Versi√≥n y servicios que corren bajo los puertos encontrados</li>
  <li>p - Especificamos que puertos queremos analizar (los que encontramos abiertos en el paso anterior)</li>
</ul>

<p>Con estos dos escaneos bastar√≠a para responder a dos de las preguntas planteadas:</p>

<ul>
  <li>¬øCu√°ntos puertos abiertos existen?</li>
  <li>¬øEn qu√© puerto est√° corriendo el protocolo FTP?</li>
  <li>¬øCu√°l es la versi√≥n del servicio ProFTPD que se est√° corriendo?</li>
</ul>

<p>Para responder a estas dos √∫ltimas preguntas solo tenemos que revisar el escaneo de versiones y servicios que realizamos con <em>Nmap</em>; por otra parte, la primera pregunta tiene algo de trampa, ya que la respuesta correcta es <code class="language-plaintext highlighter-rouge">7</code> puertos abiertos, mientras que con nuestro escaneo detectamos <code class="language-plaintext highlighter-rouge">11</code>, ¬øqu√© hicimos mal?</p>

<p>Nada, lo que sucede es que nosotros al indicar el par√°metro <code class="language-plaintext highlighter-rouge">-p-</code>, estamos escaneando todo el rango de puertos, si no indic√°ramos este par√°metro, <em>Nmap</em> escanear√≠a √∫nicamente los <code class="language-plaintext highlighter-rouge">1000</code> puertos m√°s comunes, por lo que vemos que <em>TryHackMe</em> no se dio la molestia de escanearlo todo por completo.</p>

<p>Habiendo aclarado esto, los puertos abiertos m√°s relevantes que encontramos son el <code class="language-plaintext highlighter-rouge">139</code> y el <code class="language-plaintext highlighter-rouge">445</code>, ambos relacionados con el protocolo <code class="language-plaintext highlighter-rouge">SMB</code> (Server Message Block), el puerto <code class="language-plaintext highlighter-rouge">111</code> relacionado con el servicio <code class="language-plaintext highlighter-rouge">rpcbind</code>, relacionado a su vez con <code class="language-plaintext highlighter-rouge">RPC</code> (Remote Procedure Call), y el puerto <code class="language-plaintext highlighter-rouge">21</code> relacionado con el protocolo <code class="language-plaintext highlighter-rouge">FTP</code> (File Transfer Protocol).</p>

<p>En este punto, <em>TryHackMe</em> nos sugiere usar el propio <em>Nmap</em> para enumerar los recursos compartidos a trav√©s de <code class="language-plaintext highlighter-rouge">Samba</code>, que si bien podemos hacerlo, optaremos por usar <code class="language-plaintext highlighter-rouge">SMBMap</code> y <code class="language-plaintext highlighter-rouge">smbclient</code>.</p>

<h3 id="smbmap"><a href="#header-3"></a>SMBMap</h3>

<p>Para poder listar los recursos compartidos haciendo uso de <code class="language-plaintext highlighter-rouge">SMBMap</code>, bastar√° con indicar la direci√≥n IP de la m√°quina v√≠ctima.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/2.png" alt="" /></p>

<p>Lo primero que podemos darnos cuenta es que existen <code class="language-plaintext highlighter-rouge">3</code> recursos compartidos, de los cuales solo tenemos acceso a uno, <code class="language-plaintext highlighter-rouge">anonymous</code>.</p>

<p>Si decidimos listar de manera recursiva el recurso <code class="language-plaintext highlighter-rouge">anonymous</code>, encontraremos un archivo que lleva por nombre <code class="language-plaintext highlighter-rouge">log.txt</code>, el cual ya levanta nuestras sospechas.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> &lt;direcci√≥n IP&gt; <span class="nt">-R</span> anonymous
</code></pre></div></div>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/3.png" alt="" /></p>

<p>Para poder descargar el archivo <code class="language-plaintext highlighter-rouge">log.txt</code>, podremos hacerlo usando tanto su ruta absoluta con el par√°metro <code class="language-plaintext highlighter-rouge">--download</code>, o bien creando patrones mediante <em>expresiones regulares</em> con el par√°metro <code class="language-plaintext highlighter-rouge">-A</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> &lt;direcci√≥n IP&gt; <span class="nt">--download</span> anonymous/log.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbmap <span class="nt">-H</span> &lt;direcci√≥n IP&gt; <span class="nt">-R</span> anonymous <span class="nt">-A</span> log.txt
</code></pre></div></div>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/4.png" alt="" /></p>

<h3 id="smbclient"><a href="#header-3"></a>smbclient</h3>

<p>Para poder listar los recursos compartidos haciendo uso de <code class="language-plaintext highlighter-rouge">smbclient</code> tendremos que especificar el par√°metro <code class="language-plaintext highlighter-rouge">-L</code>, adicional a ello tendremos que indicar que queremos hacer uso de un <code class="language-plaintext highlighter-rouge">null session</code> con el par√°metro <code class="language-plaintext highlighter-rouge">-N</code>, ya que no conocemos credenciales con las cuales autenticarnos; esto con <code class="language-plaintext highlighter-rouge">SMBMap</code> no ocurr√≠a ya que por defecto hace uso de un <code class="language-plaintext highlighter-rouge">null session</code>, a no ser que le indiquemos un usuario y contrase√±a.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient <span class="nt">-N</span> <span class="nt">-L</span> &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/5.png" alt="" /></p>

<p>En este caso, no se nos indica los permisos que tenemos sobre los recursos, no obstante, podemos intuir a que recursos tenemos acceso, por ejemplo, el recurso <a href="https://wiki.samba.org/index.php/Setting_up_Automatic_Printer_Driver_Downloads_for_Windows_Clients#Setting_up_the_.5Bprint.24.5D_Share">print$</a> se relaciona con impresoras que que se est√°n compartiendo a nivel de red, por otra parte tenemos el recurso <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/networking/inter-process-communication-share-null-session">IPC$</a> el cual crea el propio <em>Windows</em> para poder hacer uso de los <em>null sessions</em>; de modo que de los <code class="language-plaintext highlighter-rouge">3</code> recursos compartidos existentes, solo nos queda <code class="language-plaintext highlighter-rouge">anonymous</code>.</p>

<p>Lo siguiente que haremos ser√° listar el contenido que se encuentra dentro del recurso <code class="language-plaintext highlighter-rouge">anonymous</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient <span class="nt">-N</span> //direcci√≥n IP/anonymous
<span class="nb">ls</span>
</code></pre></div></div>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/6.png" alt="" /></p>

<p>Podemos observar que dentro existe un archivo llamado <code class="language-plaintext highlighter-rouge">log.txt</code>, el cual procederemos a descargar.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smbclient <span class="nt">-N</span> //direcci√≥n IP/anonymous
get log.txt
</code></pre></div></div>
<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/7.png" alt="" /></p>

<p>Independientemente de como hayamos descargado el archivo <code class="language-plaintext highlighter-rouge">log.txt</code>, al leerlo, lo m√°s importante que encontraremos ser√° la ubicaci√≥n del par de claves <code class="language-plaintext highlighter-rouge">RSA</code>, ubicadas en <code class="language-plaintext highlighter-rouge">/home/kenobi/.ssh/id_rsa</code>.</p>

<p>Adicionalmente, encontraremos informaci√≥n tanto del servicio <code class="language-plaintext highlighter-rouge">ProFTPD</code>, como del <code class="language-plaintext highlighter-rouge">Samba</code>, pero nada realmente interesante, por lo que estamos omitiendo algo.</p>

<p>Si recordamos, el puerto <code class="language-plaintext highlighter-rouge">111</code>, relacionado con <code class="language-plaintext highlighter-rouge">rpcbind</code>, estaba abierto, y lo que nos mostraba nuestro escaneo de versiones y servicios con <em>Nmap</em>, es que en este puerto est√° corriendo a su vez el protocolo <code class="language-plaintext highlighter-rouge">NFS</code> (Network File System) en el puerto <code class="language-plaintext highlighter-rouge">2049</code>.</p>

<p>El protocolo <code class="language-plaintext highlighter-rouge">NFS</code> se utiliza principalmente para acceder a archivos compartidos a nivel de red, de manera local. Comprobemos si se est√° compartiendo alg√∫n recurso que podamos <em>montar</em> en nuestro equipo.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>showmount <span class="nt">-e</span> &lt;direcci√≥n IP&gt;
</code></pre></div></div>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/8.png" alt="" /></p>

<p>La ruta <code class="language-plaintext highlighter-rouge">/var</code> est√° siendo compartida a nivel de red, de modo que si logr√°ramos mover alg√∫n archivo potencial dentro de esta ruta, y luego la mont√°semos en nuestro equipo, podr√≠amos visualizar dicho archivo de manera local.</p>

<h3 id="fase-de-explotaci√≥n"><a href="#header-3"></a>Fase De Explotaci√≥n</h3>

<p>Lo primero que podemos pensar es buscar alguna vulnerabilidad en el servicio <code class="language-plaintext highlighter-rouge">ProFTPD</code>, basado en <code class="language-plaintext highlighter-rouge">FTP</code> (File Transfer Protocol), moviendo as√≠ archivos desde el lado del cliente, hacia el servidor.</p>

<p>Para explotar el servicio <code class="language-plaintext highlighter-rouge">ProFTPD</code>, empezaremos buscando alg√∫n exploit que se encuentre en <em>Exploit Database</em>, para ello utilizaremos <em>SearchSploit</em> para poder seguir trabajando desde nuestra terminal.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>searchsploit ProFTPD 1.3.5
</code></pre></div></div>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/9.png" alt="" /></p>

<p>De los <code class="language-plaintext highlighter-rouge">4</code> exploits que encontramos, nos quedaremos con el √∫ltimo</p>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/10.png" alt="" /></p>

<p>Concretamente con las l√≠neas 12, 13 y 14.</p>

<p><img src="http://0.0.0.0:80/2022-02-07-Kenobi-TryHackMe/11.png" alt="" /></p>

<p>Las cuales nos permiten hacer justamente lo que nos interesa, copiar un archivo de una ruta (CPFR), a otra (CPTO).</p>

<h3 id="escalada-de-privilegios"><a href="#header-3"></a>Escalada De Privilegios</h3>

<p>GHI1</p>
:ET